# 事件组

## 事件位

事件位用于表示事件是否发生。事件位通常称为事件标志。例如，一个应用程序可能: 

*   定义一个位(或标志)，当设置为1时表示"一条已被接收并准备进行处理的消息"，设置为0时表示"没有等待处理的消息"。
*   定义一个位(或标志)，当设置为1时表示"应用程序已将准备发送到网络的消息放入队列"，设置为"没有准备送到网络的消息放入队列发"时设置为0。  
*   定义一个位(或标志)，设置为1时表示"是时候向网络发送心跳消息"，设置为0时表示“还没有时间发送另一条心跳消息”。 

## 事件组

事件组表示一组事件位。事件组内的事件位根据位号进行引用。扩展上面提供的示例:

*   表示"已收到消息并准备处理"的事件位可能是事件组中的位号0。
*   表示"应用程序已将准备发送到网络的消息放入队列"的事件位可能是同一事件组中的第1位。 
*   表示"是时候将心跳消息发送到网络上"的事件位可能是同一事件组中的第2位。

## 事件组和事件位的数据类型

事件组由*EventGroupHandle_t*类型的变量引用。

若*configUSE_16_BIT_TICKS*设置为1，则事件组中存储的位(或标志)数为8; 若*configUSE_16_BIT_TICKS*设置为0，则事件组中存储的位(或标志)数为24。*configUSE_16_BIT_TICKS*的依赖源是任务的内部实现中用于线程本地存储的数据类型。 

事件组中的所有事件位都存储在EventBits_t类型的单个无符号变量中。事件位0存储在位0，事件位1存储在位1，依此类推。

下图表示一个24位事件组，使用三位来保存已经描述的三个示例事件。在该图中，仅将事件位2置1。

![事件组](https://freertos.org/fr-content-src/uploads/2018/07/24-bit-event-group.gif "仅有3位被使用的24个事件位的事件组")

## 事件组RTOS API函数

事件组API函数用于支持任务将一个或多个事件组内的一个或多个事件位置1，清除一个事件组内的一个或多个事件位，以及挂起以等待一组一个或多个事件位在事件组内置1。

事件组还可用于同步任务，创建通常称为"同步点"的任务。任务同步点是应用程序代码中的一个位置，在该位置任务将在阻塞状态中等待，直到参与同步的所有其他任务也到达它们的同步点。 

## RTOS事件组实现必须克服的挑战

RTOS在事件组实现时必须克服的两个主要挑战是:

1.$\underline{避免在用户的应用程序中创建竞争条件}$: 

如果出现以下情况，事件组实现将在应用程序中创建竞争条件: 

*   未明确谁负责清除单个事件位；
*   未明确清除事件位的时间；
*   未明确在任务退出测试位值的API函数时是否置1或清0(可能是另一个任务或中断已更改该位的状态)

FreeRTOS事件组实现通过包含内置编译机制来确保位的设置、测试和清除看起来是原子的，从而消除了竞争条件的可能性。因此，需要注意线程本地存储和API函数返回值的谨慎使用。

2.$\underline{避免不确定性}$: 

事件组的概念意味着非确定性行为，因为应用程序不知道在一个事件组上有多少任务被阻塞，因此当事件位被置1时，不知道有多少条件需要被测试或任务被解除阻塞。

FreeRTOS质量标准不允许在禁用中断时或在中断服务函数中执行非确定性操作。为了确保在事件位置1时不会违反这些严格的质量标准：

*   RTOS调度程序的锁定机制用于确保在RTOS任务将事件位置1时中断保持启用状态；
*   集中式延迟中断机制用于在尝试从中断服务程序中将事件位置1时延迟为任务位置1的操作。

## 例程代码

API 文档中提供了示例代码片段，*EventGroupsDemo.c*标准demo任务集(源文件位于FreeRTOS/Demo/Common/Minimal目录)中提供了一个综合示例。
